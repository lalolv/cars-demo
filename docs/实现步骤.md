# 汽车展示台 - 实现步骤

## 阶段一：项目基础搭建

### 1.1 创建项目结构

```
cars-demo/
├── scenes/
│   ├── main.tscn              # 主场景
│   ├── stage.tscn             # 舞台组件
│   └── ui/
│       ├── main_ui.tscn       # 主界面
│       └── car_selector.tscn  # 汽车选择器
├── scripts/
│   ├── main.gd                # 主场景控制
│   ├── orbit_camera.gd        # 轨道摄像机
│   ├── rotating_stage.gd      # 旋转舞台
│   ├── audio_visualizer.gd    # 音频分析
│   ├── car_manager.gd         # 汽车管理
│   └── music_player.gd        # 音乐播放器
├── assets/
│   ├── models/                # 汽车模型 (.glb)
│   ├── music/                 # 背景音乐 (.ogg)
│   └── textures/              # 纹理贴图
└── resources/
	└── car_data.tres          # 汽车配置资源
```

### 1.2 配置项目设置

在 `project.godot` 中添加：

```ini
[input]
# 已有的输入映射保留，添加触摸支持

[audio]
# 启用音频总线用于频谱分析
```

补充说明（Godot 4.6）：

**输入映射（触摸）**
- Input Map 的事件配置弹窗只支持键盘/鼠标/手柄，不包含 `InputEventScreenTouch` 或 `InputEventScreenDrag`，因此不需要也无法为触摸事件配置动作。
- 触摸输入应在脚本里直接处理：`_input(event)` 中判断 `InputEventScreenTouch` / `InputEventScreenDrag`。

**音频总线（频谱分析）**
- 在编辑器底部 **Audio** 面板为 `Master` 总线添加 `SpectrumAnalyzer` 效果，然后保存总线布局（会写入 `default_bus_layout.tres`）。

## 阶段二：核心场景搭建

### 2.1 主场景节点结构

```
Main (Node3D)
├── WorldEnvironment
├── DirectionalLight3D
├── OrbitCamera (Camera3D)         # 轨道摄像机
├── Stage (Node3D)                 # 舞台根节点
│   ├── Platform (MeshInstance3D)  # 圆形底座
│   └── CarMount (Node3D)          # 汽车挂载点
├── AudioStreamPlayer             # 音乐播放
└── CanvasLayer
	└── MainUI                    # 用户界面
```

### 2.2 创建旋转舞台

**stage.tscn 结构：**

```
Stage (Node3D) [rotating_stage.gd]
├── Platform (MeshInstance3D)
│   └── StaticBody3D
│       └── CollisionShape3D (CylinderShape3D)
└── CarMount (Node3D)
```

**rotating_stage.gd:**

```gdscript
extends Node3D

@export var rotation_speed: float = 5.0  # 度/秒
@export var auto_rotate: bool = true

var current_car: Node3D = null
@onready var car_mount: Node3D = $CarMount

func _process(delta: float) -> void:
	if auto_rotate:
		rotate_y(deg_to_rad(rotation_speed * delta))

func set_car(car_scene: PackedScene) -> void:
	# 移除旧车
	if current_car:
		current_car.queue_free()

	# 加载新车
	current_car = car_scene.instantiate()
	car_mount.add_child(current_car)
```

### 2.3 创建轨道摄像机

**orbit_camera.gd:**

```gdscript
extends Camera3D

@export var target: Node3D
@export var distance: float = 8.0
@export var min_distance: float = 4.0
@export var max_distance: float = 15.0
@export var rotation_speed: float = 0.5
@export var min_pitch: float = 10.0  # 度
@export var max_pitch: float = 60.0  # 度

var _yaw: float = 0.0
var _pitch: float = 45.0
var _touch_positions: Dictionary = {}

func _ready() -> void:
	_update_camera_position()

func _input(event: InputEvent) -> void:
	# 触摸开始/移动/结束
	if event is InputEventScreenTouch:
		if event.pressed:
			_touch_positions[event.index] = event.position
		else:
			_touch_positions.erase(event.index)

	elif event is InputEventScreenDrag:
		_touch_positions[event.index] = event.position

		if _touch_positions.size() == 1:
			# 单指：旋转
			_yaw -= event.relative.x * rotation_speed
			_pitch += event.relative.y * rotation_speed
			_pitch = clamp(_pitch, min_pitch, max_pitch)
			_update_camera_position()

		elif _touch_positions.size() == 2:
			# 双指：缩放
			_handle_pinch_zoom(event)

func _handle_pinch_zoom(event: InputEventScreenDrag) -> void:
	var touches = _touch_positions.values()
	var current_dist = touches[0].distance_to(touches[1])
	# 计算缩放...（需要存储上一帧距离）

func _update_camera_position() -> void:
	if not target:
		return

	var offset = Vector3.ZERO
	offset.x = distance * sin(deg_to_rad(_yaw)) * cos(deg_to_rad(_pitch))
	offset.y = distance * sin(deg_to_rad(_pitch))
	offset.z = distance * cos(deg_to_rad(_yaw)) * cos(deg_to_rad(_pitch))

	global_position = target.global_position + offset
	look_at(target.global_position)
```

## 阶段三：舞台环形灯与音频联动

### 3.1 设置音频总线

1. 打开 Godot 编辑器底部的 **Audio** 面板
2. 在 Master 总线上添加效果：**SpectrumAnalyzer**
3. 保存总线布局

### 3.3 音频分析器

**audio_visualizer.gd:**

```gdscript
extends Node

@export var spectrum_analyzer_bus: StringName = &"Master"

var spectrum: AudioEffectSpectrumAnalyzerInstance
var min_freq: float = 20.0
var max_freq: float = 4000.0

func _ready() -> void:
	var bus_idx = AudioServer.get_bus_index(spectrum_analyzer_bus)
	var effect_idx = 0  # SpectrumAnalyzer 效果的索引
	spectrum = AudioServer.get_bus_effect_instance(bus_idx, effect_idx)

func _process(_delta: float) -> void:
	if not spectrum:
		return

	var ring_low = min_freq
	var ring_high = max_freq
	var magnitude = spectrum.get_magnitude_for_frequency_range(ring_low, ring_high).length()
	var normalized = clamp((60 + linear_to_db(magnitude)) / 60.0, 0.0, 1.0)
	# 将 normalized 传给舞台环形材质参数（如 glow_intensity）
```

## 阶段四：汽车与音乐管理

### 4.1 汽车管理器

**car_manager.gd:**

```gdscript
extends Node

signal car_changed(car_name: String)

@export var stage: Node3D
@export var car_scenes: Array[PackedScene] = []
@export var car_names: Array[String] = []

var current_index: int = 0

func _ready() -> void:
	if car_scenes.size() > 0:
		_load_car(0)

func switch_to_car(index: int) -> void:
	if index < 0 or index >= car_scenes.size():
		return

	current_index = index
	_load_car(index)

func _load_car(index: int) -> void:
	if stage.has_method("set_car"):
		stage.set_car(car_scenes[index])
		car_changed.emit(car_names[index])

func get_car_list() -> Array[String]:
	return car_names
```

### 4.2 音乐播放器

**music_player.gd:**

```gdscript
extends Node

signal music_changed(music_name: String)

@export var audio_player: AudioStreamPlayer
@export var music_list: Array[AudioStream] = []
@export var music_names: Array[String] = []
@export var crossfade_duration: float = 1.0

var current_index: int = 0
var _tween: Tween

func play_music(index: int) -> void:
	if index < 0 or index >= music_list.size():
		return

	current_index = index

	# 淡出当前音乐
	if audio_player.playing:
		_tween = create_tween()
		_tween.tween_property(audio_player, "volume_db", -40, crossfade_duration)
		await _tween.finished

	# 切换并淡入
	audio_player.stream = music_list[index]
	audio_player.volume_db = -40
	audio_player.play()

	_tween = create_tween()
	_tween.tween_property(audio_player, "volume_db", 0, crossfade_duration)

	music_changed.emit(music_names[index])

func toggle_play() -> void:
	if audio_player.playing:
		audio_player.stream_paused = not audio_player.stream_paused
	else:
		audio_player.play()
```

## 阶段五：用户界面

### 5.1 主界面结构

**main_ui.tscn:**

```
MainUI (Control)
├── TopBar (HBoxContainer)
│   ├── SettingsButton (Button)
│   └── MusicControls (HBoxContainer)
│       ├── PlayPauseButton (Button)
│       ├── VolumeSlider (HSlider)
│       └── MusicSelector (OptionButton)
├── CarSelector (ScrollContainer)
│   └── HBoxContainer
│       └── CarButton1, CarButton2, ... (TextureButton)
└── SettingsPanel (PanelContainer) [默认隐藏]
	└── VBoxContainer
		├── RotationSpeedSlider
		├── LightIntensitySlider
		└── AutoRotateCheckBox
```

### 5.2 汽车选择器

```gdscript
# car_selector.gd
extends ScrollContainer

signal car_selected(index: int)

@export var car_button_scene: PackedScene
@export var car_thumbnails: Array[Texture2D] = []

@onready var container: HBoxContainer = $HBoxContainer

func _ready() -> void:
	for i in range(car_thumbnails.size()):
		var button = TextureButton.new()
		button.texture_normal = car_thumbnails[i]
		button.pressed.connect(_on_car_button_pressed.bind(i))
		container.add_child(button)

func _on_car_button_pressed(index: int) -> void:
	car_selected.emit(index)
```

## 阶段六：整合与测试

### 6.1 主场景脚本

**main.gd:**

```gdscript
extends Node3D

@onready var car_manager: Node = $CarManager
@onready var music_player: Node = $MusicPlayer
@onready var audio_visualizer: Node = $AudioVisualizer
@onready var stage: Node3D = $Stage
@onready var main_ui: Control = $CanvasLayer/MainUI

func _ready() -> void:
	# 连接信号
	main_ui.car_selector.car_selected.connect(_on_car_selected)
	main_ui.music_selector.item_selected.connect(_on_music_selected)

	# 初始化
	music_player.play_music(0)

func _on_car_selected(index: int) -> void:
	car_manager.switch_to_car(index)

func _on_music_selected(index: int) -> void:
	music_player.play_music(index)
```

### 6.2 测试清单

- [ ] 手势旋转摄像机是否平滑
- [ ] 双指缩放是否正常工作
- [ ] 舞台是否持续旋转
- [ ] 汽车模型切换是否正常
- [ ] 光柱是否跟随音乐变化
- [ ] 音乐切换是否有渐变效果
- [ ] UI 在不同分辨率下是否正常显示
- [ ] 移动端性能是否达到 60 FPS

## 阶段七：资源准备

### 7.1 汽车模型

- 从 Sketchfab、CGTrader 等获取 GLTF/GLB 格式模型
- 或使用 Godot 基础形状创建占位模型用于测试

### 7.2 音乐文件

- 准备 OGG 格式音乐文件（Godot 推荐格式）
- 放置在 `assets/music/` 目录

### 7.3 材质与纹理

- 舞台底座：金属或玻璃材质
- 光柱：自发光材质
- 环境：HDR 天空盒（可选）
